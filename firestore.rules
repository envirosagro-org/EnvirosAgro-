rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 1. User Profiles
    match /users/{userId} {
      // Anyone can read profiles (needed for Worker Cloud search)
      allow read: if true; 
      
      // Users can only update their own profile details (Bio, Photo)
      // BUT they CANNOT edit their 'wallet' or 'worker_profile' (skills)
      // Those are only updated by the Admin SDK (Cloud Functions above)
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['wallet', 'worker_profile']);
    }

    // 2. Uploads (Community Feed)
    match /uploads/{uploadId} {
      allow read: if true;
      allow create: if request.auth != null; // Must be logged in to post
    }

    // 3. The Ledger (Financial History)
    match /ledger/{transactionId} {
      // Users can read their OWN transactions only
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      // NO ONE can write here directly. Only the System (Cloud Function).
      allow write: if false; 
    }
    
    // 4. Tutorial Completions (System-Only)
    match /tutorialCompletions/{completionId} {
        // Only the system can create these records to trigger the function.
        allow read: if request.auth != null && resource.data.userId == request.auth.uid; // Users can see their own completions
        allow write: if false;
    }
  }
}